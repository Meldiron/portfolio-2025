<section>
  <div
    class="flex flex-col items-center justify-center overflow-hidden relative"
  >
    <div
      class="absolute right-0 h-full w-[50px] bg-gradient-to-r from-transparent to-[#000]"
    >
    </div>
    <div
      class="absolute left-0 h-full w-[50px] bg-gradient-to-l from-transparent to-[#000]"
    >
    </div>

    <div id="contributions" class="flex gap-1">
      {
        Array.apply(null, Array(53)).map((week, i) => {
          return (
            <div
              id={`week-${i}`}
              class={`flex-col gap-1 ${i < 20 ? "hidden md:flex" : "flex"}`}
            >
              {Array.apply(null, Array(7)).map((day, j) => {
                return (
                  <div
                    id={`week-${i}-day-${j}`}
                    class="h-1.5 w-1.5 md:h-2 md:w-2 lg:h-3 lg:w-3 rounded-sm"
                    style="background-color: rgba(255, 255, 255, 0.05);"
                  />
                );
              })}
            </div>
          );
        })
      }
    </div>
    <p class="my-1 hidden" id="contribution-error">Something went wrong.</p>
  </div>
</section>
<script>
  /**
   * Types for our data
   */
  type ContributionDay = {
    color: string;
    contributionCount: number;
    date: string;
    weekday: number;
  };
  type Week = {
    contributionDays: ContributionDay[];
    firstDay: string;
  };
  type Weeks = Week[];
  type GraphQLRes = {
    user: {
      contributionsCollection: {
        contributionCalendar: {
          weeks: Weeks;
        };
      };
    };
  };

  /**
   * Fetch against GitHub GraphQL API
   */
  async function getContributions(token: string, username: string) {
    const headers = {
      Authorization: `bearer ${token}`,
    };
    const body = {
      query: `query {
              user(login: "${username}") {
                name
                contributionsCollection {
                  contributionCalendar {
                    colors
                    totalContributions
                    weeks {
                      contributionDays {
                        color
                        contributionCount
                        date
                        weekday
                      }
                      firstDay
                    }
                  }
                }
              }
            }`,
    };
    const response = await fetch("https://api.github.com/graphql", {
      method: "POST",
      body: JSON.stringify(body),
      headers: headers,
    });
    const data = await response.json();
    return data;
  }

  /**
   * Run fetch from above
   */
  const { data } = await getContributions(
    import.meta.env.PRIVATE_GITHUB_TOKEN, // token in .env file
    "Meldiron", // your GitHub account name
  );
  console.log("data", data);

  /**
   * If there's an error with the fetch or the user doesn't exist, show error text
   */
  if (!data || !data.user) {
    const oops = document.getElementById("contribution-error");
    oops?.classList.remove("hidden");
    throw "Error fetching from Github";
  }

  /**
   * Drill down to data from fetch request
   */
  const {
    user: {
      contributionsCollection: {
        contributionCalendar: { weeks },
      },
    },
  }: GraphQLRes = data;

  /**
   * Loop through the weeks + add them to the parent div
   */
  weeks.forEach(({ contributionDays }, i) => {
    // Loop through each week's days + add them to their week
    contributionDays.forEach(({ color, date, contributionCount }, j) => {
      let contributionsColor = "rgba(255, 255, 255, 0.10)";

      if (contributionCount >= 15) {
        contributionsColor = "#39d353";
      } else if (contributionCount >= 10) {
        contributionsColor = "#26a641";
      } else if (contributionCount >= 5) {
        contributionsColor = "#006d32";
      } else if (contributionCount >= 1) {
        contributionsColor = "#0e4429";
      }

      if (contributionsColor === "#ebedf0") {
        contributionsColor = "rgba(255, 255, 255, 0.1)";
      }

      // Get + update each day square
      const dayDiv = document.getElementById(`week-${i}-day-${j}`);
      dayDiv?.setAttribute("style", `background-color: ${contributionsColor}`);
      dayDiv?.setAttribute(
        "title",
        `${date} - ${contributionCount} public commits`,
      );
    });
  });
</script>
