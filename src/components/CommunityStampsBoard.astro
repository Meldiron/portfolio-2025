<div class="space-y-1 relative" x-data={`minigame()`}>
  <!-- Board -->
  <div
    @mousedown="handleBoardClick($event)"
    @touchstart="handleTouchStart($event)"
    @dragstart.prevent
    @selectstart.prevent
    @contextmenu.prevent="isDragging"
    data-board
    class="relative w-full h-80 bg-gradient-to-tr from-neutral-950 via-black to-neutral-950 rounded-xl border border-neutral-700 overflow-hidden shadow-lg select-none"
    :class="isDragging ? 'cursor-grabbing' : 'cursor-grab'"
  >
    <!-- Board texture/pattern -->
    <div class="absolute inset-0 opacity-10 pointer-events-none">
      <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern
            id="grid"
            width="20"
            height="20"
            patternUnits="userSpaceOnUse"
          >
            <path
              d="M 20 0 L 0 0 0 20"
              fill="none"
              stroke="white"
              stroke-width="0.5"></path>
          </pattern>
        </defs>
        <rect
          width="100%"
          height="100%"
          fill="url(#grid)"
          :style="`transform: translate(${virtualX % 20}px, ${virtualY % 20}px);`"
        ></rect>
      </svg>
    </div>

    <!-- Cork board texture -->
    <div
      class="absolute inset-0 bg-gradient-to-br from-neutral-800/5 to-neutral-800/5 pointer-events-none"
    >
    </div>

    <!-- Dynamic loading/updating indicator -->
    <div
      x-show="isPendingEmojis || isLoadingEmojis"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="absolute top-2 right-2 z-20 pointer-events-none"
    >
      <div
        class="flex items-center gap-2 backdrop-blur-sm border rounded-lg px-3 py-2 shadow-lg bg-neutral-900/80 border-neutral-700"
      >
        <div class="w-4 h-4 flex items-center justify-center">
          <div
            x-show="!isLoadingEmojis && isPendingEmojis"
            class="w-2 h-2 bg-neutral-400 rounded-full animate-pulse"
          >
          </div>
          <div
            x-show="isLoadingEmojis"
            class="w-4 h-4 border-2 border-neutral-600 border-t-white rounded-full animate-spin"
          >
          </div>
        </div>
        <span
          x-show="isLoadingEmojis"
          class="text-xs font-medium text-neutral-300">Updating</span
        >
      </div>
    </div>

    <!-- Subtle shadow overlay -->
    <div
      class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent pointer-events-none"
    >
    </div>

    <!-- Rendered Emojis -->
    <template x-for="(emoji, index) in emojis" :key="emoji.id">
      <div
        :style="`left: ${emoji.x + virtualX}px; top: ${emoji.y + virtualY}px; transform: translate(-50%, -50%) rotate(${+emoji.rotation}deg); font-size: ${emojiSizeToPx(emoji.size)}`"
        class="absolute pointer-events-none select-none"
      >
        <span
          class="stamp-appear inline-block"
          :style="`animation-delay: ${(index % 25) * 25}ms`"
          x-text="emoji.emoji"
        ></span>
      </div>
    </template>
  </div>

  <!-- Wheel Selector (outside board to avoid clipping) -->
  <template x-if="wheelVisible">
    <div
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-75"
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 scale-100"
      x-transition:leave-end="opacity-0 scale-75"
      :style="`left: ${wheelX}px; top: ${wheelY}px; transform: translate(-50%, -50%);`"
      data-wheel
      class="absolute z-50 pointer-events-auto"
    >
      <div class="flex flex-col items-center gap-3">
        <!-- Size Configuration -->
        <div
          class="bg-neutral-800/90 backdrop-blur-sm border border-neutral-600 rounded-lg p-2 shadow-xl"
        >
          <div class="flex items-center gap-1">
            <template x-for="(size, index) in sizes" :key="size">
              <button
                @click.stop="selectedSize = size"
                :class="selectedSize === size ? 'bg-neutral-600' : 'bg-neutral-700/80 hover:bg-neutral-600/80'"
                class="w-6 h-6 border border-neutral-500 rounded flex items-center justify-center text-xs transition-colors duration-200"
                :title="`Size: ${size === 'text-lg' ? 'Small' : size === 'text-2xl' ? 'Medium' : 'Large'}`"
                x-text="size === 'text-lg' ? 'S' : size === 'text-2xl' ? 'M' : 'L'"
              >
              </button>
            </template>
          </div>
        </div>

        <!-- Emoji Wheel -->
        <div class="relative w-32 h-32">
          <!-- Wheel background -->
          <div
            class="absolute inset-0 bg-neutral-800/90 backdrop-blur-sm rounded-full border border-neutral-600 shadow-xl"
          >
          </div>

          <!-- Wheel options -->
          <template x-for="(option, index) in options" :key="index">
            <button
              :disabled="isLoading"
              @click.stop="!isLoading && selectOption(option)"
              :style="`transform: rotate(${index * 60}deg) translateY(-40px) rotate(-${index * 60}deg) translateX(48px) translateY(48px);`"
              class="absolute left-0 top-0 w-8 h-8 bg-neutral-700/80 hover:bg-neutral-600/80 disabled:opacity-50 border border-neutral-500 rounded-full flex items-center justify-center text-lg transition-colors duration-200 cursor-pointer"
              x-text="option"
            >
            </button>
          </template>

          <!-- Loading spinner -->
          <div
            x-show="isLoading"
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4"
          >
            <div
              class="w-full h-full border-2 border-neutral-600 border-t-white bg-neutral-950 rounded-full animate-spin"
            >
            </div>
          </div>

          <!-- Center dot -->
          <div
            x-show="!isLoading"
            class="absolute top-1/2 left-1/2 w-4 h-4 -translate-x-1/2 -translate-y-1/2 bg-neutral-950 border-neutral-600 border rounded-full"
          >
          </div>
        </div>

        <!-- Rotation Configuration -->
        <div
          class="bg-neutral-800/90 backdrop-blur-sm border border-neutral-600 rounded-lg p-2 shadow-xl"
        >
          <div class="flex items-center gap-1">
            <template x-for="rotation in rotations" :key="rotation">
              <button
                @click.stop="selectedRotation = rotation"
                :class="selectedRotation === rotation ? 'bg-neutral-600' : 'bg-neutral-700/80 hover:bg-neutral-600/80'"
                class="w-6 h-6 border border-neutral-500 rounded flex items-center justify-center text-xs transition-colors duration-200"
                :title="`Rotation: ${rotation}°`"
                x-text="rotation === 0 ? '↑' : rotation > 0 ? '↗' : '↖'"
              >
              </button>
            </template>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Position Controls -->
  <div class="text-sm absolute left-3 top-1">
    <div class="flex flex-col items-start gap-1">
      <div class="flex items-center gap-1">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6 transform rotate-90"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path>
        </svg>

        <input
          type="number"
          x-model.number="virtualX"
          :style="`width: ${30 + (virtualX ?? '').toString().length * 8}px`"
          class="bg-transparent focus:bg-neutral-950 focus:border border-neutral-600 rounded text-white text-center focus:outline-none focus:border-neutral-400 font-mono transition-colors"
        />
      </div>
      <div class="flex items-center gap-1 text-neutral-400">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path>
        </svg>

        <input
          type="number"
          x-model.number="virtualY"
          :style="`width: ${30 + (virtualY ?? '').toString().length * 8}px`"
          class="bg-transparent focus:bg-neutral-950 focus:border border-neutral-600 rounded text-white text-center focus:outline-none focus:border-neutral-400 font-mono transition-colors"
        />
      </div>
    </div>
  </div>
  <!-- Position Controls -->
  <div
    class="flex items-center justify-end gap-2 text-sm absolute right-3 top-1"
  >
    <button
      @click="resetPosition()"
      class="py-1 px-1 bg-transparent hover:bg-neutral-800 rounded text-neutral-300 hover:text-white transition-colors duration-200 text-xs"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="size-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M7.5 3.75H6A2.25 2.25 0 0 0 3.75 6v1.5M16.5 3.75H18A2.25 2.25 0 0 1 20.25 6v1.5m0 9V18A2.25 2.25 0 0 1 18 20.25h-1.5m-9 0H6A2.25 2.25 0 0 1 3.75 18v-1.5M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
        ></path>
      </svg>
    </button>
  </div>
</div>

<style>
  @keyframes stamp-appear {
    0% {
      opacity: 0;
      transform: scale(0);
    }
    60% {
      transform: scale(1.15);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  .stamp-appear {
    animation: stamp-appear 0.35s ease-out both;
  }
</style>
